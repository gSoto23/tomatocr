{% extends "base_dashboard.html" %}

{% block title %}Calendario | TOMATO{% endblock %}

{% block content %}
<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
    <div>
        <h1 class="text-2xl font-bold text-gray-900">Calendario de Operaciones</h1>
        <p class="mt-1 text-sm text-gray-500">
            {% if user.role == 'admin' %}
            Asignación de proyectos y personal.
            {% elif user.role == 'supervisor' %}
            Gestión de asignaciones y proyectos personales.
            {% else %}
            Tus proyectos asignados.
            {% endif %}
        </p>
    </div>
    {% if user.role in ['admin', 'supervisor'] %}
    <button onclick="openModal()"
        class="inline-flex items-center justify-center rounded-md bg-black px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-gray-800 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-black">
        <svg class="-ml-0.5 mr-1.5 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd"
                d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z"
                clip-rule="evenodd" />
        </svg>
        Asignar Proyecto
    </button>
    {% endif %}
</div>

<div class="bg-white shadow-sm rounded-lg border border-gray-200 p-4 overflow-x-auto">
    <div id='calendar'></div>
</div>

<!-- Scheduling Modal (Admin/Supervisor) -->
{% if user.role in ['admin', 'supervisor'] %}
<div id="scheduleModal" class="relative z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>

    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center">

            <div
                class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all w-full sm:my-8 sm:w-full sm:max-w-lg">
                <form id="scheduleForm" action="/calendar/schedule" method="post">
                    <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                                <h3 class="text-base font-semibold leading-6 text-gray-900" id="modal-title">Gestión de
                                    Asignación</h3>
                                <div class="mt-4 space-y-4">

                                    <!-- Date Range -->
                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        <div>
                                            <label for="date"
                                                class="block text-sm font-medium leading-6 text-gray-900">Fecha
                                                Inicio</label>
                                            <input type="date" name="date" id="date" required
                                                class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-black sm:text-sm sm:leading-6">
                                        </div>
                                        <div id="end-date-container">
                                            <label for="end_date"
                                                class="block text-sm font-medium leading-6 text-gray-900">Fecha Fin
                                                (Opcional)</label>
                                            <input type="date" name="end_date" id="end_date"
                                                class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-black sm:text-sm sm:leading-6">
                                            <p class="text-xs text-gray-500 mt-1">Dejar vacío para un solo día</p>
                                        </div>
                                    </div>

                                    <!-- Project -->
                                    <div>
                                        <label for="project_id"
                                            class="block text-sm font-medium leading-6 text-gray-900">Proyecto</label>
                                        <select name="project_id" id="project_id" required
                                            class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-black sm:text-sm sm:leading-6">
                                            {% for p in projects %}
                                            <option value="{{ p.id }}">{{ p.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <div>
                                        <label for="user_id"
                                            class="block text-sm font-medium leading-6 text-gray-900">Trabajador</label>
                                        <select name="user_id" id="user_id" required
                                            class="block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-black sm:text-sm sm:leading-6">
                                            {% for w in workers %}
                                            <option value="{{ w.id }}">{{ w.full_name or w.username }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <!-- Tasks Checklist -->
                                    <!-- Tasks Checklist (Manual) -->
                                    <div>
                                        <label class="block text-sm font-medium leading-6 text-gray-900 mb-2">Tareas
                                            Asignadas</label>
                                        <div id="tasks-list" class="space-y-2 mb-2">
                                            <!-- Inputs injected here -->
                                        </div>
                                        <button type="button" onclick="addTaskInput()"
                                            class="inline-flex items-center text-sm font-medium text-black hover:text-gray-700">
                                            <svg class="mr-1 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                                stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round"
                                                    d="M12 4.5v15m7.5-7.5h-15" />
                                            </svg>
                                            Agregar Tarea
                                        </button>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="defaultButtons">
                        <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 gap-2">
                            <!-- Save Button -->
                            <button type="submit"
                                class="inline-flex w-full justify-center rounded-md bg-black px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-gray-800 sm:w-auto">Guardar</button>

                            <!-- Delete Button (Only for editing) -->
                            <button type="button" id="deleteBtn" onclick="showDeleteConfirmation()"
                                class="hidden inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:w-auto">Eliminar</button>

                            <!-- Cancel -->
                            <button type="button" onclick="closeModal()"
                                class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">Cancelar</button>
                        </div>
                    </div>

                    <!-- Delete Confirmation Buttons -->
                    <!-- Delete Confirmation Buttons -->
                    <div id="confirmDeleteButtons" class="hidden">
                        <div class="bg-red-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 gap-2">
                            <button type="button" onclick="executeDelete()"
                                class="inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:w-auto">Sí,
                                Eliminar</button>
                            <button type="button" onclick="cancelDelete()"
                                class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">Cancelar</button>
                            <p class="text-sm text-red-700 font-semibold self-center mr-auto hidden sm:block">¿Estás
                                seguro?
                            </p>
                        </div>
                    </div>
                </form>

                <!-- Hidden Delete Form -->
                <form id="deleteForm" method="post" class="hidden"></form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Worker Task Modal (Read Only + Checkboxes) -->
{% if user.role not in ['admin', 'supervisor'] %}
<div id="workerScheduleModal" class="relative z-50 hidden" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center">
            <div
                class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all w-full sm:my-8 sm:w-full sm:max-w-lg">
                <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                            <h3 class="text-base font-semibold leading-6 text-gray-900" id="worker-modal-title">Detalles
                                de Asignación</h3>
                            <div class="mt-4 space-y-4">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Proyecto</p>
                                    <p class="text-lg font-bold text-gray-900" id="worker-project-name">-</p>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Fecha</p>
                                    <p class="text-base text-gray-900" id="worker-date">-</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium leading-6 text-gray-900 mb-2">Tareas
                                        Asignadas</label>
                                    <div id="worker-tasks-list"
                                        class="space-y-2 mb-2 border rounded-md p-3 bg-gray-50 max-h-60 overflow-y-auto">
                                        <!-- Checkboxes injected here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                    <button type="button" onclick="closeWorkerModal()"
                        class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">Cerrar</button>
                    <!-- Optional: Go to Project Button -->
                    <a id="worker-project-link" href="#"
                        class="inline-flex w-full justify-center rounded-md bg-black px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-gray-800 sm:w-auto sm:mr-3">Ir
                        al Proyecto</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script>
    {% if user.role in ['admin', 'supervisor'] %}
    let currentScheduleId = null;

    // Handle Project Change (No longer needed for tasks, but kept if we need logic later)
    // document.getElementById('project_id').addEventListener('change', ...);

    function addTaskInput(titleVal = '', descVal = '') {
        const container = document.getElementById('tasks-list');
        const div = document.createElement('div');
        div.className = "flex flex-col gap-2 p-3 border rounded-md bg-gray-50 relative task-item";
        div.innerHTML = `
            <div class="flex justify-between">
                 <input type="text" class="task-title block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-black sm:text-sm sm:leading-6 mr-2" 
                        placeholder="Título de la tarea" value="${titleVal}">
                 <button type="button" onclick="this.closest('.task-item').remove()" class="text-gray-400 hover:text-red-500">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <textarea class="task-desc block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-black sm:text-sm sm:leading-6"
                      rows="2" placeholder="Descripción detallada">${descVal}</textarea>
        `;
        container.appendChild(div);
    }

    function openModal(dateStr = '', schedule = null) {
        const modal = document.getElementById('scheduleModal');
        const form = document.getElementById('scheduleForm');
        const deleteBtn = document.getElementById('deleteBtn');
        const title = document.getElementById('modal-title');
        const endDateContainer = document.getElementById('end-date-container');

        // Reset UI state
        document.getElementById('defaultButtons').classList.remove('hidden');
        document.getElementById('confirmDeleteButtons').classList.add('hidden');

        modal.classList.remove('hidden');

        if (schedule) {
            // Edit Mode
            currentScheduleId = schedule.id;
            title.innerText = 'Editar Asignación';
            form.action = `/calendar/schedule/${schedule.id}/edit`;
            deleteBtn.classList.remove('hidden');

            // Hide End Date for Edit (Single Instance)
            if (endDateContainer) endDateContainer.classList.add('hidden');

            document.getElementById('date').value = schedule.start; // YYYY-MM-DD
            document.getElementById('end_date').value = ''; // Clear it
            document.getElementById('project_id').value = schedule.extendedProps.project_id;
            document.getElementById('user_id').value = schedule.extendedProps.worker_id;

            // Load manual tasks
            document.getElementById('tasks-list').innerHTML = '';
            const tasks = schedule.extendedProps.tasks || [];
            if (tasks.length > 0) {
                tasks.forEach(t => addTaskInput(t.title || '', t.description));
            } else {
                addTaskInput(); // Add one empty by default
            }
        } else {
            // Create Mode
            currentScheduleId = null;
            title.innerText = 'Asignar Proyecto';
            form.action = '/calendar/schedule';
            deleteBtn.classList.add('hidden');

            // Show End Date for Create
            if (endDateContainer) endDateContainer.classList.remove('hidden');

            document.getElementById('date').value = dateStr || new Date().toISOString().split('T')[0];
            document.getElementById('end_date').value = ''; // Default to empty (single day)
            document.getElementById('project_id').selectedIndex = 0;
            document.getElementById('user_id').selectedIndex = 0;

            // Reset tasks list
            document.getElementById('tasks-list').innerHTML = '';
            addTaskInput(); // Add one empty
        }
    }

    function closeModal() {
        document.getElementById('scheduleModal').classList.add('hidden');
        currentScheduleId = null;
    }

    // Handle Form Submit (Fetch + Toaster)
    document.getElementById('scheduleForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        // Serialize tasks
        const tasks = [];
        document.querySelectorAll('.task-item').forEach(item => {
            const title = item.querySelector('.task-title').value;
            const desc = item.querySelector('.task-desc').value;
            if (title.trim() || desc.trim()) {
                tasks.push({ title: title, description: desc });
            }
        });

        // Create FormData but override tasks
        const formData = new FormData(this);
        formData.delete('tasks'); // Clear old if any
        formData.append('tasks_json', JSON.stringify(tasks));

        const action = this.action;

        try {
            const response = await fetch(action, {
                method: 'POST',
                body: formData
            });
            const result = await response.json();

            if (response.ok) {
                closeModal();
                showGlobalToast("Éxito", result.message || "Operación exitosa");
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showGlobalToast("Error", result.message || "Error desconocido", "error");
            }
        } catch (error) {
            console.error(error);
            showGlobalToast("Error", "Error de conexión", "error");
        }
    });

    function showDeleteConfirmation() {
        document.getElementById('defaultButtons').classList.add('hidden');
        document.getElementById('confirmDeleteButtons').classList.remove('hidden');
    }

    function cancelDelete() {
        document.getElementById('defaultButtons').classList.remove('hidden');
        document.getElementById('confirmDeleteButtons').classList.add('hidden');
    }

    async function executeDelete() {
        if (!currentScheduleId) return;

        try {
            const response = await fetch(`/calendar/schedule/${currentScheduleId}/delete`, {
                method: 'POST'
            });
            const result = await response.json();

            if (response.ok) {
                closeModal();
                showGlobalToast("Éxito", result.message || "Eliminado correctamente");
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showGlobalToast("Error", result.message || "Error al eliminar", "error");
            }
        } catch (error) {
            console.error(error);
            showGlobalToast("Error", "Error de conexión", "error");
        }
    }
    {% endif %}

    {% if user.role not in ['admin', 'supervisor'] %}
    function openWorkerModal(event) {
        document.getElementById('workerScheduleModal').classList.remove('hidden');
        document.getElementById('worker-project-name').innerText = event.extendedProps.project_name;
        let dateDisplay = event.startStr;
        if (dateDisplay.includes('T')) {
            dateDisplay = dateDisplay.split('T')[0];
        }
        const parts = dateDisplay.split('-');
        if (parts.length === 3) {
            dateDisplay = `${parts[2]}-${parts[1]}-${parts[0]}`;
        }
        document.getElementById('worker-date').innerText = dateDisplay;
        document.getElementById('worker-project-link').href = `/projects/${event.extendedProps.project_id}`;

        const container = document.getElementById('worker-tasks-list');
        container.innerHTML = '';
        const tasks = event.extendedProps.tasks || [];

        if (tasks.length === 0) {
            container.innerHTML = '<p class="text-sm text-gray-400 italic">No hay tareas específicas asignadas.</p>';
        } else {
            tasks.forEach(task => {
                const div = document.createElement('div');
                div.className = "flex items-start p-2 hover:bg-gray-100 rounded";
                div.innerHTML = `
                    <div class="flex h-5 items-center mt-1">
                        <input id="w-task-${task.id}" type="checkbox" ${task.completed ? 'checked' : ''}
                            onchange="toggleTask(${task.id}, this)"
                            class="h-4 w-4 rounded border-gray-300 text-black focus:ring-black cursor-pointer">
                    </div>
                    <div class="ml-3 text-sm w-full">
                        ${task.title ? `<strong class="block text-gray-900 ${task.completed ? 'line-through text-gray-500' : ''}">${task.title}</strong>` : ''}
                        <label for="w-task-${task.id}" class="block text-gray-700 cursor-pointer ${task.completed ? 'line-through text-gray-400' : ''}">${task.description}</label>
                    </div>
                `;
                container.appendChild(div);
            });
        }
    }

    function closeWorkerModal() {
        document.getElementById('workerScheduleModal').classList.add('hidden');
    }

    async function toggleTask(taskId, checkbox) {
        const container = checkbox.closest('.flex').nextElementSibling;
        const titleEl = container.querySelector('strong');
        const descEl = container.querySelector('label');

        // Optimistic UI update
        if (checkbox.checked) {
            if (titleEl) titleEl.classList.add('line-through', 'text-gray-500');
            descEl.classList.add('line-through', 'text-gray-400');
        } else {
            if (titleEl) titleEl.classList.remove('line-through', 'text-gray-500');
            descEl.classList.remove('line-through', 'text-gray-400');
        }

        try {
            const response = await fetch(`/calendar/task/${taskId}/toggle`, { method: 'POST' });
            const result = await response.json();
            if (!response.ok) {
                // Revert
                checkbox.checked = !checkbox.checked;
                // Re-apply optimistic logic reversed
                if (checkbox.checked) {
                    if (titleEl) titleEl.classList.add('line-through', 'text-gray-500');
                    descEl.classList.add('line-through', 'text-gray-400');
                } else {
                    if (titleEl) titleEl.classList.remove('line-through', 'text-gray-500');
                    descEl.classList.remove('line-through', 'text-gray-400');
                }
                showGlobalToast("Error", result.message || "Error al actualizar", "error");
            } else {
                showGlobalToast("Actualizado", "Estado de tarea actualizado");
            }
        } catch (e) {
            console.error(e);
            checkbox.checked = !checkbox.checked;
            showGlobalToast("Error", "Error de conexión", "error");
        }
    }
    {% endif %}

    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        var initialView = window.innerWidth < 768 ? 'listWeek' : 'dayGridMonth';

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: initialView,
            locale: 'es',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,listWeek'
            },
            buttonText: {
                today: 'Hoy',
                month: 'Mes',
                list: 'Lista'
            },
            height: 'auto',
            aspectRatio: 1.5,
            windowResize: function (view) {
                if (window.innerWidth < 768) {
                    calendar.changeView('listWeek');
                    calendar.setOption('headerToolbar', {
                        left: 'prev,next',
                        center: 'title',
                        right: 'today' // Simplified for mobile
                    });
                } else {
                    calendar.changeView('dayGridMonth');
                    calendar.setOption('headerToolbar', {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,listWeek'
                    });
                }
            },
            events: '/calendar/events',
            eventClick: function (info) {
                info.jsEvent.preventDefault();

                {% if user.role in ['admin', 'supervisor'] %}
                openModal(null, info.event);
                {% else %}
                openWorkerModal(info.event);
        {% endif %}
    },
        {% if user.role in ['admin', 'supervisor'] %}
    dateClick: function (info) {
        openModal(info.dateStr);
    },
    {% endif %}
    eventDidMount: function(info) {
        // Style improvements for events in list view or month view
        if (info.view.type === 'dayGridMonth') {
            // Make them look pill-like or similar to design
        }
    }
        });

    // Initial mobile adjustment
    if (window.innerWidth < 768) {
        calendar.setOption('headerToolbar', {
            left: 'prev,next',
            center: 'title',
            right: 'today'
        });
    }

    calendar.render();
    });
</script>
{% endblock %}