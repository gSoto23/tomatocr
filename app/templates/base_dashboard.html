<!DOCTYPE html>
<html lang="es" class="h-full bg-gray-50">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Dashboard | TOMATO{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        tomato: {
                            black: '#000000',
                            white: '#ffffff',
                        }
                    }
                }
            }
        }
    </script>
</head>

<body class="h-full flex flex-col md:flex-row overflow-hidden" x-data="{ sidebarOpen: false }">

    <!-- Mobile Header -->
    <div class="md:hidden bg-black text-white p-4 flex items-center justify-between shrink-0">
        <div class="flex items-center gap-2">
            <img src="/static/images/LogoTomatoW.png" alt="TOMATO" class="h-6">
            <span class="font-bold tracking-wide text-sm">SISTEMA</span>
        </div>
        <button @click="sidebarOpen = true" class="text-white hover:text-gray-300">
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
        </button>
    </div>

    <!-- Mobile Sidebar Overlay -->
    <div x-show="sidebarOpen" x-transition:enter="transition-opacity ease-linear duration-300"
        x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
        x-transition:leave="transition-opacity ease-linear duration-300" x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0" class="fixed inset-0 bg-gray-900/80 z-40 md:hidden"
        @click="sidebarOpen = false"></div>

    <!-- Sidebar -->
    <aside :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full'"
        class="fixed inset-y-0 left-0 z-50 w-64 bg-black text-white transition-transform duration-300 ease-in-out md:translate-x-0 md:static md:inset-0 md:flex md:w-64 md:flex-col shadow-xl md:shadow-none">

        <div class="p-6 border-b border-white/10 flex items-center justify-between gap-3">
            <div class="flex items-center gap-3">
                <img src="/static/images/LogoTomatoW.png" alt="TOMATO" class="h-8">
                <span class="font-bold tracking-wide">SISTEMA</span>
            </div>
            <!-- Close Button (Mobile Only) -->
            <button @click="sidebarOpen = false" class="md:hidden text-gray-400 hover:text-white">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
            <a href="/dashboard"
                class="group flex items-center px-3 py-2 text-sm font-medium rounded-md bg-white/10 text-white">
                <svg class="mr-3 h-5 w-5 text-white/70 group-hover:text-white" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                Dashboard
            </a>

            <a href="/projects"
                class="group flex items-center px-3 py-2 text-sm font-medium rounded-md text-white/70 hover:bg-white/10 hover:text-white transition-colors">
                <svg class="mr-3 h-5 w-5 text-white/70 group-hover:text-white" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                </svg>
                Proyectos
            </a>

            {% if user.role == 'admin' %}
            <a href="/logs"
                class="group flex items-center px-3 py-2 text-sm font-medium rounded-md text-white/70 hover:bg-white/10 hover:text-white transition-colors">
                <svg class="mr-3 h-5 w-5 text-white/70 group-hover:text-white" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Bitácora
            </a>
            {% endif %}

            {% if user.role == 'admin' or user.role == 'worker' %}
            <a href="/calendar"
                class="group flex items-center px-3 py-2 text-sm font-medium rounded-md text-white/70 hover:bg-white/10 hover:text-white transition-colors">
                <svg class="mr-3 h-5 w-5 text-white/70 group-hover:text-white" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                Calendario
            </a>
            {% endif %}

            {% if user.role == "admin" %}
            <a href="/users"
                class="group flex items-center px-3 py-2 text-sm font-medium rounded-md text-white/70 hover:bg-white/10 hover:text-white transition-colors">
                <svg class="mr-3 h-5 w-5 text-white/70 group-hover:text-white" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                Usuarios
            </a>
            {% endif %}
        </nav>

        <div class="p-4 border-t border-white/10">
            <div class="flex items-center gap-3">
                <div class="h-8 w-8 rounded-full bg-white/20 flex items-center justify-center font-bold text-xs">
                    {{ user.username[:2].upper() }}
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium truncate">{{ user.full_name or user.username }}</p>
                    <p class="text-xs text-white/50 truncate">{{ user.role }}</p>
                </div>
                <a href="/logout" class="p-2 text-white/50 hover:text-white" title="Cerrar sesión">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                </a>
            </div>
        </div>
    </aside>

    <!-- Content Area -->
    <main class="flex-1 flex flex-col min-h-0 overflow-hidden bg-gray-50">
        <!-- Main Header (Desktop) -->
        <header class="bg-white shadow-sm border-b border-gray-200 p-4 md:flex items-center justify-between hidden">
            <h1 class="text-xl font-bold text-gray-900 leading-tight truncate">
                {% block header_title %}Dashboard{% endblock %}
            </h1>
        </header>

        <!-- Main Content -->
        <div class="flex-1 overflow-auto p-4 md:p-8">
            {% block content %}{% endblock %}
        </div>
    </main>

    <!-- Global Toast Notification -->
    <div id="global-toast"
        class="fixed bottom-4 right-4 z-[100] hidden transition-all duration-300 transform translate-y-full opacity-0">
        <div class="bg-black text-white px-6 py-4 rounded-lg shadow-xl flex items-center gap-3 min-w-[300px]">
            <div id="toast-icon-container" class="rounded-full bg-green-500/20 p-1">
                <svg class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
            </div>
            <div class="flex-1">
                <h4 id="toast-title" class="font-semibold text-sm">Éxito</h4>
                <p id="toast-message" class="text-xs text-gray-300 mt-0.5">Operación realizada correctamente.</p>
            </div>
            <button onclick="closeGlobalToast()" class="text-gray-400 hover:text-white">
                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>

    <script>
        // Global Toast Functions
        function showGlobalToast(title, message, type = 'success') {
            const toast = document.getElementById('global-toast');
            const iconContainer = document.getElementById('toast-icon-container');

            if (title) document.getElementById('toast-title').textContent = title;
            if (message) document.getElementById('toast-message').textContent = message;

            // Icon Logic
            if (type === 'error') {
                // Red X
                iconContainer.className = "rounded-full bg-red-500/20 p-1";
                iconContainer.innerHTML = `
                    <svg class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                `;
            } else {
                // Green Check (Success)
                iconContainer.className = "rounded-full bg-green-500/20 p-1";
                iconContainer.innerHTML = `
                    <svg class="h-5 w-5 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                `;
            }

            toast.classList.remove('hidden');
            // Small delay for transition
            setTimeout(() => {
                toast.classList.remove('translate-y-full', 'opacity-0');
            }, 10);

            // Auto close after 3s
            setTimeout(() => {
                closeGlobalToast();
            }, 5000);
        }

        function closeGlobalToast() {
            const toast = document.getElementById('global-toast');
            toast.classList.add('translate-y-full', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 300);
        }

        // Check for toast cookie on load
        document.addEventListener('DOMContentLoaded', function () {
            const getCookie = (name) => {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
            }

            const toastMsg = getCookie('toast_message');
            if (toastMsg) {
                // Decode URI component because cookie value might be encoded
                const decodedMsg = decodeURIComponent(toastMsg).replace(/\+/g, ' ');
                showGlobalToast('Éxito', decodedMsg);

                // Delete cookie
                document.cookie = "toast_message=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            }
        });
    </script>
</body>

</html>