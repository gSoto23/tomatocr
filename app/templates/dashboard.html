{% extends "base_dashboard.html" %}

{% block title %}Dashboard | Inicio{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-2xl font-bold text-gray-900">Bienvenido, {{ user.full_name or user.username }}</h1>
    <p class="mt-1 text-sm text-gray-500">Resumen de operaciones.</p>
</div>

<!-- ADMIN VIEW -->
{% if user.role == 'admin' %}

<!-- Filters -->
<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-6" x-data="{ showFilters: false }">
    <div class="flex justify-between items-center mb-4 cursor-pointer" @click="showFilters = !showFilters">
        <h3 class="font-bold text-gray-900 flex items-center gap-2">
            <svg class="w-5 h-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
            </svg>
            Filtros
        </h3>
        <svg class="w-5 h-5 text-gray-500 transform transition-transform" :class="showFilters ? 'rotate-180' : ''"
            fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
    </div>

    <form action="/dashboard" method="GET" x-show="showFilters" x-transition>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Inicio</label>
                <input type="date" name="start_date" value="{{ request.query_params.get('start_date', '') }}"
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-black focus:ring-black sm:text-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Fin</label>
                <input type="date" name="end_date" value="{{ request.query_params.get('end_date', '') }}"
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-black focus:ring-black sm:text-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
                <select name="invoice_status"
                    class="block w-full rounded-md border-gray-300 shadow-sm focus:border-black focus:ring-black sm:text-sm">
                    <option value="all" {% if request.query_params.get('invoice_status')=='all' %}selected{% endif %}>
                        Todos</option>
                    <option value="pendiente" {% if request.query_params.get('invoice_status')=='pendiente' %}selected{%
                        endif %}>Pendiente (Amarillo)</option>
                    <option value="pago_parcial" {% if request.query_params.get('invoice_status')=='pago_parcial'
                        %}selected{% endif %}>Pago Parcial (Naranja)</option>
                    <option value="vencida" {% if request.query_params.get('invoice_status')=='vencida' %}selected{%
                        endif %}>Vencida (Rojo)</option>
                    <option value="pagada" {% if request.query_params.get('invoice_status')=='pagada' %}selected{% endif
                        %}>Pagada (Verde)</option>
                </select>
            </div>
            <div class="flex gap-2">
                <button type="submit"
                    class="rounded-md bg-black px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-gray-800 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-black flex-1">
                    Filtrar
                </button>
                <a href="/dashboard"
                    class="rounded-md bg-white px-4 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 flex-1 text-center">
                    Limpiar
                </a>
            </div>
        </div>
    </form>
</div>
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <!-- Active Projects -->
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
        <div class="flex items-center gap-4">
            <div class="p-3 bg-green-50 text-green-600 rounded-lg">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                    </path>
                </svg>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-500">Proyectos Activos</p>
                <p class="text-2xl font-bold text-gray-900">{{ data.stats.active_projects }}</p>
            </div>
        </div>
    </div>

    <!-- Total Adjudicated -->
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
        <div class="flex items-center gap-4">
            <div class="p-3 bg-blue-50 text-blue-600 rounded-lg">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                    </path>
                </svg>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-500">Total Adjudicado</p>
                <p class="text-2xl font-bold text-gray-900">{{ "{:,.2f}".format(data.stats.total_adjudicated) }}</p>
            </div>
        </div>
    </div>

    <!-- Total Invoiced -->
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
        <div class="flex items-center gap-4">
            <div class="p-3 bg-purple-50 text-purple-600 rounded-lg">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                    </path>
                </svg>
            </div>
            <div>
                <p class="text-sm font-medium text-gray-500">Total Facturado</p>
                <p class="text-2xl font-bold text-gray-900">{{ "{:,.2f}".format(data.stats.total_invoiced) }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Admin Recent Activity: Invoices -->
<div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-100">
        <h3 class="font-bold text-gray-900">Actividad Reciente (Facturación)</h3>
    </div>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Factura
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Proyecto
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Vencimiento</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado
                    </th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acción
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for inv in data.recent_activity %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ inv.invoice_number }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ inv.budget.project.name if
                        inv.budget and inv.budget.project else 'N/A' }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ "{:,.2f}".format(inv.amount) }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ inv.due_date }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if inv.status == 'vencida' %}
                        <span
                            class="inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-xs font-medium text-red-700 ring-1 ring-inset ring-red-600/10">Vencida</span>
                        {% elif inv.status == 'pago_parcial' %}
                        <span
                            class="inline-flex items-center rounded-md bg-orange-50 px-2 py-1 text-xs font-medium text-orange-800 ring-1 ring-inset ring-orange-600/20">Pago
                            Parcial</span>
                        {% else %}
                        <span
                            class="inline-flex items-center rounded-md bg-yellow-50 px-2 py-1 text-xs font-medium text-yellow-800 ring-1 ring-inset ring-yellow-600/20">Pendiente</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <a href="/finance/{{ inv.budget.project_id }}"
                            class="text-indigo-600 hover:text-indigo-900">Ver</a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="px-6 py-8 text-center text-sm text-gray-500 italic">No hay facturas
                        pendientes recientes.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- CLIENT VIEW -->
{% elif user.role == 'client' %}
<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
    <div>
        <h3 class="font-bold text-gray-900 text-lg">Bitácora Global</h3>
        <p class="text-sm text-gray-500">Reportes de tus proyectos asignados.</p>
    </div>

    <!-- Filter Form -->
    <form action="/dashboard" method="get" class="flex items-center gap-2 w-full sm:w-auto">
        <select name="project_id" onchange="this.form.submit()"
            class="block w-full rounded-md border-0 py-1.5 pl-3 pr-10 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-black sm:text-sm sm:leading-6 sm:w-64">
            <option value="">Todos mis Proyectos</option>
            {% for p in data.projects %}
            <option value="{{ p.id }}" {% if data.selected_project_id==p.id %}selected{% endif %}>{{ p.name }}</option>
            {% endfor %}
        </select>
    </form>
</div>

<div class="bg-white shadow-sm rounded-lg border border-gray-200 overflow-x-auto mb-6">
    <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
            <tr>
                <th scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer group"
                    onclick="window.location.href='?sort=date&order={{ 'asc' if data.sort == 'date' and data.order == 'desc' else 'desc' }}{% if data.selected_project_id %}&project_id={{ data.selected_project_id }}{% endif %}'">
                    <div class="flex items-center">
                        Fecha
                        <span class="ml-1 text-gray-400">
                            {% if data.sort == 'date' %}
                            {% if data.order == 'asc' %}
                            &#8593;
                            {% else %}
                            &#8595;
                            {% endif %}
                            {% else %}
                            &#8597;
                            {% endif %}
                        </span>
                    </div>
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Proyecto</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Usuario</th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Detalle</th>
                <th scope="col" class="relative px-6 py-3"><span class="sr-only">Ver</span></th>
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
            {% for log in data.logs %}
            <tr>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {{ log.date | format_date }}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="text-sm font-medium text-gray-900">{{ log.project.name }}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div
                            class="h-6 w-6 rounded-full bg-gray-100 flex items-center justify-center text-xs font-bold text-gray-600 mr-2">
                            {{ log.user.username[:2].upper() }}
                        </div>
                        <div class="text-sm font-medium text-gray-900">{{ log.user.full_name or log.user.username }}
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 text-sm text-gray-500 truncate max-w-xs block">
                    {{ log.notes or '-' }}
                    {% if log.photos %}
                    <span
                        class="inline-flex items-center rounded-md bg-gray-100 px-1.5 py-0.5 text-xs font-medium text-gray-600 ml-1">
                        <svg class="h-3 w-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path
                                d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" />
                        </svg>
                        {{ log.photos|length }}
                    </span>
                    {% endif %}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button onclick="openLogModal({{ log.id }})" class="text-indigo-600 hover:text-indigo-900">Ver
                        Detalle</button>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5" class="px-6 py-10 text-center text-sm text-gray-500">
                    No se encontraron bitácoras para tus proyectos.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% from "components/pagination.html" import render_pagination %}
    <!-- Construct endpoint with existing query params -->
    {% set base_url = '/dashboard' %}
    {% if data.selected_project_id %}
    {% set base_url = base_url ~ '?project_id=' ~ data.selected_project_id %}
    {% endif %}

    {{ render_pagination(data.page, data.total_pages, base_url) }}
</div>

{% include 'components/log_modal.html' %}

<!-- WORKER VIEW -->
{% elif user.role == 'worker' %}
<div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-100">
        <h3 class="font-bold text-gray-900">Mis Asignaciones (Calendario)</h3>
    </div>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Proyecto
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tareas
                    </th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acción
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for schedule in data.recent_activity %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ schedule.date |
                        format_date }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {% if schedule.project %}
                        <a href="/projects/{{ schedule.project.id }}"
                            class="text-indigo-600 hover:text-indigo-900 font-medium">
                            {{ schedule.project.name }}
                        </a>
                        {% else %}
                        N/A
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">
                        <ul class="list-disc pl-4 space-y-1">
                            {% for task in schedule.tasks %}
                            <li class="{{ 'line-through text-gray-400' if task.completed else '' }}">{{ task.description
                                }}</li>
                            {% else %}
                            <li class="italic text-gray-400">Sin tareas definidas</li>
                            {% endfor %}
                        </ul>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button type="button" onclick='openWorkerModal({
                            id: {{ schedule.id }},
                            project_name: "{{ schedule.project.name if schedule.project else "N/A" }}",
                            date: "{{ schedule.date | format_date }}",
                            project_id: "{{ schedule.project_id }}",
                            tasks: [
                                {% for t in schedule.tasks %}
                                { id: {{ t.id }}, description: "{{ t.description }}", completed: {{ "true" if t.completed else "false" }} },
                                {% endfor %}
                            ]
                        })' class="text-indigo-600 hover:text-indigo-900 font-semibold">
                            Gestionar
                        </button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4" class="px-6 py-8 text-center text-sm text-gray-500 italic">No tienes asignaciones
                        recientes.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Worker Modal & Scripts -->
{% if user.role == 'worker' %}
<div id="workerScheduleModal" class="relative z-50 hidden" aria-labelledby="modal-title" role="dialog"
    aria-modal="true">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center">
            <div
                class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all w-full sm:my-8 sm:w-full sm:max-w-lg">
                <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                            <h3 class="text-base font-semibold leading-6 text-gray-900" id="worker-modal-title">Detalles
                                de Asignación</h3>
                            <div class="mt-4 space-y-4">
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Proyecto</p>
                                    <p class="text-lg font-bold text-gray-900" id="worker-project-name">-</p>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-500">Fecha</p>
                                    <p class="text-base text-gray-900" id="worker-date">-</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium leading-6 text-gray-900 mb-2">Tareas
                                        Asignadas</label>
                                    <div id="worker-tasks-list"
                                        class="space-y-2 mb-2 border rounded-md p-3 bg-gray-50 max-h-60 overflow-y-auto">
                                        <!-- Checkboxes injected here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                    <button type="button" onclick="closeWorkerModal()"
                        class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">Cerrar</button>
                    <!-- Optional: Go to Project Button -->
                    <a id="worker-project-link" href="#"
                        class="inline-flex w-full justify-center rounded-md bg-black px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-gray-800 sm:w-auto sm:mr-3">Ir
                        al Proyecto</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function openWorkerModal(data) {
        document.getElementById('workerScheduleModal').classList.remove('hidden');
        document.getElementById('worker-project-name').innerText = data.project_name;
        document.getElementById('worker-date').innerText = data.date;
        document.getElementById('worker-project-link').href = `/projects/${data.project_id}`;

        const container = document.getElementById('worker-tasks-list');
        container.innerHTML = '';
        const tasks = data.tasks || [];

        if (tasks.length === 0) {
            container.innerHTML = '<p class="text-sm text-gray-400 italic">No hay tareas específicas asignadas.</p>';
        } else {
            tasks.forEach(task => {
                const div = document.createElement('div');
                div.className = "flex items-start p-2 hover:bg-gray-100 rounded";
                div.innerHTML = `
                    <div class="flex h-5 items-center">
                        <input id="w-task-${task.id}" type="checkbox" ${task.completed ? 'checked' : ''}
                            onchange="toggleTask(${task.id}, this)"
                            class="h-4 w-4 rounded border-gray-300 text-black focus:ring-black cursor-pointer">
                    </div>
                    <div class="ml-3 text-sm">
                        <label for="w-task-${task.id}" class="font-medium text-gray-700 cursor-pointer ${task.completed ? 'line-through text-gray-400' : ''}">${task.description}</label>
                    </div>
                `;
                container.appendChild(div);
            });
        }
    }

    function closeWorkerModal() {
        document.getElementById('workerScheduleModal').classList.add('hidden');
    }

    async function toggleTask(taskId, checkbox) {
        const label = checkbox.parentElement.nextElementSibling.querySelector('label');
        // Optimistic UI update
        if (checkbox.checked) {
            label.classList.add('line-through', 'text-gray-400');
        } else {
            label.classList.remove('line-through', 'text-gray-400');
        }

        try {
            const response = await fetch(`/calendar/task/${taskId}/toggle`, { method: 'POST' });
            const result = await response.json();
            if (!response.ok) {
                // Revert on error
                checkbox.checked = !checkbox.checked;
                if (checkbox.checked) {
                    label.classList.add('line-through', 'text-gray-400');
                } else {
                    label.classList.remove('line-through', 'text-gray-400');
                }
                showGlobalToast("Error", result.message || "Error al actualizar", "error");
            } else {
                showGlobalToast("Actualizado", "Estado de tarea actualizado");
                // Refresh page after a short delay to keep stats in sync? 
                // Not strictly necessary for dashboard view unless we want to update the list view "Strikethrough"
                // Let's update the list view item too if possible.
                // But simpler to just leave as is. User can refresh if they want.
            }
        } catch (e) {
            console.error(e);
            // Revert on error
            checkbox.checked = !checkbox.checked;
            showGlobalToast("Error", "Error de conexión", "error");
        }
    }
</script>
{% endif %}

{% endblock %}